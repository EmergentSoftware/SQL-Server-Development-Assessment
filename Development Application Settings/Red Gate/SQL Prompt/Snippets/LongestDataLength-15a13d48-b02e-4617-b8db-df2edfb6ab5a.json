{
  "id": "15a13d48-b02e-4617-b8db-df2edfb6ab5a",
  "prefix": "LongestDataLength",
  "description": "ES: This script help find the longest data value in each of the text columns. Helpful for creating ETL tables.",
  "body": "DECLARE @TableName sysname = '<SchemaName, , dbo>.<TableName, , MyTable>';\r\n\r\nSET NOCOUNT ON;\r\n\r\nDECLARE\r\n    @column_id        varchar(36)\r\n   ,@StringToExecute nvarchar(MAX);\r\n\r\nDROP TABLE IF EXISTS #Receiver;\r\nCREATE TABLE #Receiver (LongestDataLength int NULL);\r\n\r\nDROP TABLE IF EXISTS #Results;\r\nCREATE TABLE #Results (\r\n    column_id         varchar(36)   NOT NULL\r\n   ,TableName         sysname       NOT NULL\r\n   ,ColumnName        sysname       NOT NULL\r\n   ,DataType          sysname       NOT NULL\r\n   ,MaxColumnLength   varchar(250)  NULL\r\n   ,LongestDataLength varchar(250)  NULL\r\n   ,StringToExecute   nvarchar(MAX) NULL\r\n);\r\n\r\nINSERT INTO #Results (\r\n    column_id\r\n   ,TableName\r\n   ,ColumnName\r\n   ,DataType\r\n   ,MaxColumnLength\r\n   ,LongestDataLength\r\n   ,StringToExecute\r\n)\r\nSELECT\r\n    column_id         = C.column_id\r\n   ,TableName         = OBJECT_NAME(C.object_id)\r\n   ,ColumnName        = C.name\r\n   ,DataType          = T.name\r\n   ,MaxColumnLength   = CASE WHEN T.name NOT IN ('varchar', 'nvarchar', 'char', 'nchar', 'sysname')\r\n                                 THEN 'NA'\r\n                            WHEN C.max_length = -1\r\n                                THEN 'MAX'\r\n                            ELSE CAST(C.max_length AS varchar(250))\r\n                        END\r\n   ,LongestDataLength = 'NA'\r\n   ,StringToExecute   = N'SELECT MAX(LEN(' + C.name + ')) FROM ' + OBJECT_SCHEMA_NAME(C.object_id) + '.' + OBJECT_NAME(C.object_id) + N';'\r\nFROM\r\n    sys.columns          AS C\r\n    INNER JOIN sys.types AS T\r\n        ON C.user_type_id = T.user_type_id\r\nWHERE\r\n    C.object_id = OBJECT_ID(@TableName);\r\n\r\n\r\nDECLARE LengthCursor CURSOR LOCAL FAST_FORWARD FOR\r\n    SELECT column_id, StringToExecute FROM #Results WHERE MaxColumnLength <> 'NA' ORDER BY column_id ASC;\r\n\r\nOPEN LengthCursor;\r\n\r\nFETCH NEXT FROM LengthCursor\r\nINTO\r\n    @column_id\r\n   ,@StringToExecute;\r\n\r\nWHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n        INSERT INTO #Receiver (LongestDataLength)\r\n        EXEC sys.sp_executesql @stmt = @StringToExecute;\r\n\r\n        UPDATE\r\n            #Results\r\n        SET\r\n            LongestDataLength = (SELECT LongestDataLength FROM #Receiver)\r\n        WHERE\r\n            column_id = @column_id;\r\n\r\n        DELETE FROM #Receiver;\r\n\r\n        FETCH NEXT FROM LengthCursor\r\n        INTO\r\n            @column_id\r\n           ,@StringToExecute;\r\n    END;\r\nCLOSE LengthCursor;\r\nDEALLOCATE LengthCursor;\r\n\r\nSELECT\r\n    TableName\r\n   ,ColumnName\r\n   ,DataType\r\n   ,MaxColumnLength\r\n   ,LongestDataLength\r\nFROM\r\n    #Results;"
}
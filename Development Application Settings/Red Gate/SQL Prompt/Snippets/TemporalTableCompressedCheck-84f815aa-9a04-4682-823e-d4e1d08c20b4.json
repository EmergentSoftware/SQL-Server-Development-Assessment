{
  "id": "84f815aa-9a04-4682-823e-d4e1d08c20b4",
  "prefix": "TemporalTableCompressedCheck",
  "description": "ES: Check system-versioned temporal tables are page compressed",
  "body": "/* This query will list if system-versioned temporal tables are not compressed. \r\n   By default, the history table is PAGE compressed.\r\n   You can execute the ALTER TSQL statement to apply page compression. Do not forget to change ONLINE to ON OR OFF.\r\n   Redgate Snippet: TemporalTableCompressedCheck\r\n*/\r\nSELECT\r\n    SchemaName      = S.name\r\n   ,TableName       = T.name\r\n   ,DataCompression = P.data_compression_desc\r\n   ,[ALTER TSQL]    = N'ALTER INDEX ' + CAST(QUOTENAME(I.name) AS nvarchar(128)) + N' ON ' + CAST(QUOTENAME(S.name) AS nvarchar(128)) + N'.' + CAST(QUOTENAME(T.name) AS nvarchar(128)) + N' REBUILD PARTITION = ALL WITH (STATISTICS_NORECOMPUTE = OFF, ONLINE = ?, DATA_COMPRESSION = PAGE);'\r\nFROM\r\n    sys.partitions         AS P\r\n    INNER JOIN sys.indexes AS I\r\n        ON I.object_id = P.object_id\r\n        AND I.index_id = P.index_id\r\n    INNER JOIN sys.objects AS O\r\n        ON I.object_id = O.object_id\r\n    INNER JOIN sys.tables  AS T\r\n        ON O.object_id = T.object_id\r\n    INNER JOIN sys.schemas AS S\r\n        ON T.schema_id = S.schema_id\r\nWHERE\r\n    T.temporal_type    = 1 /* HISTORY_TABLE */\r\nAND I.type             <> 5 /* CLUSTERED */\r\nAND P.data_compression <> 2 /* Not Page compressed, which is the default for system-versioned temporal tables */\r\nORDER BY\r\n    S.name\r\n   ,T.name;"
}
{
  "id": "1a01e74c-824e-4bef-92c6-e21644ed67b5",
  "prefix": "cnt",
  "description": "ES: Safe count all rows in all tables (does not lock tables)",
  "body": "SET NOCOUNT ON;\r\nSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\nSET LOCK_TIMEOUT 1000;\r\n\r\nWITH TableList\r\n  AS (\r\n      SELECT\r\n          SchemaName = '.All'\r\n         ,TableName  = '.All'\r\n         ,Rows       = (\r\n              SELECT TOP (1)\r\n                  FORMAT(SUM(P.rows), '#,##0')\r\n              FROM\r\n                  sys.tables                AS T WITH (NOLOCK)\r\n                  INNER JOIN sys.PARTITIONS AS P WITH (NOLOCK)\r\n                      ON T.OBJECT_ID = P.object_id\r\n                      AND P.index_id IN (0, 1)\r\n          )\r\n         ,TotalGB    = FORMAT(CAST((SUM(A.total_pages) * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,TotalMB    = FORMAT(CAST(((SUM(A.total_pages) * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,TotalKB    = FORMAT(SUM(A.total_pages) * 8, '#,##0')\r\n         ,UsedGB     = FORMAT(CAST((SUM(A.used_pages) * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,UsedMB     = FORMAT(CAST(((SUM(A.used_pages) * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,UsedKB     = FORMAT(SUM(A.used_pages) * 8, '#,##0')\r\n         ,UnusedGB   = FORMAT(CAST(((SUM(A.total_pages) - SUM(A.used_pages)) * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,UnusedMB   = FORMAT(CAST(((SUM(A.total_pages) - SUM(A.used_pages)) * 8) / 1024.00 AS numeric(36, 2)), '#,##0.#0')\r\n         ,UnusedKB   = FORMAT((SUM(A.total_pages) - SUM(A.used_pages)) * 8, '#,##0')\r\n      FROM\r\n          sys.tables                      AS T WITH (NOLOCK)\r\n          INNER JOIN sys.indexes          AS I WITH (NOLOCK)\r\n              ON T.OBJECT_ID    = I.OBJECT_ID\r\n          INNER JOIN sys.PARTITIONS       AS P WITH (NOLOCK)\r\n              ON I.OBJECT_ID    = P.OBJECT_ID\r\n              AND I.index_id    = P.index_id\r\n          INNER JOIN sys.allocation_units AS A WITH (NOLOCK)\r\n              ON P.partition_id = A.container_id\r\n          LEFT OUTER JOIN sys.schemas     AS S WITH (NOLOCK)\r\n              ON T.schema_id    = S.schema_id\r\n      UNION ALL\r\n      SELECT\r\n          SchemaName = S.name\r\n         ,TableName  = T.name\r\n         ,Rows       = FORMAT(P.rows, '#,##0')\r\n         ,TotalGB    = FORMAT(CAST((SUM(DISTINCT A.total_pages) * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,TotalMB    = FORMAT(CAST(((SUM(DISTINCT A.total_pages) * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,TotalKB    = FORMAT(SUM(DISTINCT A.total_pages) * 8, '#,##0')\r\n         ,UsedGB     = FORMAT(CAST((SUM(DISTINCT A.used_pages) * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,UsedMB     = FORMAT(CAST(((SUM(DISTINCT A.used_pages) * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n\r\n         ,UsedKB     = FORMAT(SUM(A.used_pages) * 8, '#,##0')\r\n\r\n         ,UnusedGB   = FORMAT(CAST(((SUM(DISTINCT A.total_pages) - SUM(DISTINCT A.used_pages)) * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,UnusedMB   = FORMAT(CAST(((SUM(DISTINCT A.total_pages) - SUM(DISTINCT A.used_pages)) * 8) / 1024.00 AS numeric(36, 2)), '#,##0.#0')\r\n         ,UnusedKB   = FORMAT((SUM(DISTINCT A.total_pages) - SUM(DISTINCT A.used_pages)) * 8, '#,##0.#0')\r\n      FROM\r\n          sys.tables                      AS T WITH (NOLOCK)\r\n          INNER JOIN sys.indexes          AS I WITH (NOLOCK)\r\n              ON T.OBJECT_ID    = I.object_id\r\n          INNER JOIN sys.partitions       AS P WITH (NOLOCK)\r\n              ON I.object_id    = P.OBJECT_ID\r\n              AND I.index_id    = P.index_id\r\n          INNER JOIN sys.allocation_units AS A WITH (NOLOCK)\r\n              ON P.partition_id = A.container_id\r\n          LEFT OUTER JOIN sys.schemas     AS S WITH (NOLOCK)\r\n              ON T.schema_id    = S.schema_id\r\n      WHERE\r\n          t.NAME NOT LIKE 'dt%'\r\n      AND T.is_ms_shipped = 0\r\n      AND i.OBJECT_ID     > 255\r\n      GROUP BY\r\n          T.Name\r\n         ,S.Name\r\n         ,P.rows\r\n  )\r\nSELECT\r\n    *\r\nFROM\r\n    TableList\r\n--WHERE SchemaName IN ('.All', 'SomeSchemaName')\r\n--WHERE TableName IN('.All', 'SomeTableName')\r\nORDER BY\r\n    TableList.SchemaName\r\n   ,TableList.TableName\r\nOPTION (RECOMPILE);"
}
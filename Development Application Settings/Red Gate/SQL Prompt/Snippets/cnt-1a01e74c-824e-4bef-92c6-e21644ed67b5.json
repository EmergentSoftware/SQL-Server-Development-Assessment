{
  "id": "1a01e74c-824e-4bef-92c6-e21644ed67b5",
  "prefix": "cnt",
  "description": "ES: Safe count all rows in all tables (does not lock tables)",
  "body": "SET NOCOUNT ON;\r\nSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\nSET LOCK_TIMEOUT 1000;\r\n\r\nWITH TableRowCount\r\nAS (SELECT\r\n        SchemaName = '.',\r\n        TableName = '.All Tables',\r\n        TotalRowCount = FORMAT(SUM(P.rows), '#,##0')\r\n    FROM sys.tables AS T WITH (NOLOCK)\r\n    INNER JOIN sys.partitions AS P WITH (NOLOCK)\r\n        ON T.object_id = P.object_id\r\n        AND P.index_id IN (0, 1)\r\n    WHERE SCHEMA_NAME(T.schema_id) NOT IN ('SOME-SCHEMA-NAME', 'ANOTHER-SCHEMA-NAME')\r\n    AND T.name NOT IN ('SOME-TABLE-NAME', 'ANOTHER-TABLE-NAME')\r\n    UNION ALL\r\n    SELECT\r\n        SchemaName = SCHEMA_NAME(T.schema_id),\r\n        TableName = T.name,\r\n        TotalRowCount = FORMAT(SUM(P.rows), '#,##0')\r\n    FROM sys.tables AS T WITH (NOLOCK)\r\n    INNER JOIN sys.partitions AS P WITH (NOLOCK)\r\n        ON T.object_id = P.object_id\r\n        AND P.index_id IN (0, 1)\r\n    WHERE SCHEMA_NAME(T.schema_id) NOT IN ('SOME-SCHEMA-NAME', 'ANOTHER-SCHEMA-NAME')\r\n    AND T.name NOT IN ('SOME-TABLE-NAME', 'ANOTHER-TABLE-NAME')\r\n    GROUP BY SCHEMA_NAME(T.schema_id),\r\n        T.name)\r\nSELECT\r\n    TableRowCount.SchemaName,\r\n    TableRowCount.TableName,\r\n    TableRowCount.TotalRowCount\r\nFROM TableRowCount\r\nORDER BY TableRowCount.SchemaName,\r\n    TableRowCount.TableName\r\nOPTION (RECOMPILE);"
}
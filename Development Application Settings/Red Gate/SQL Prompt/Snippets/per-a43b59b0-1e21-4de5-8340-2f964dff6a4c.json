{
  "id": "a43b59b0-1e21-4de5-8340-2f964dff6a4c",
  "name": "per",
  "prefix": "per",
  "description": "ES: SQL Server Permissions (Users, Roles, Securables)",
  "body": "--Database Users\nSELECT\n    Username            = name\n   ,create_date\n   ,modify_date\n   ,type                = type_desc\n   ,authentication_type = authentication_type_desc\nFROM\n    sys.database_principals\nWHERE\n    type NOT IN ( 'A', 'G', 'R', 'X' )\n    AND sid IS NOT NULL\nORDER BY\n    Username;\n\n\n--Role Members\nSELECT\n    DatabaseRoleName = DP1.name\n   ,DatabaseUserName = ISNULL(DP2.name, 'No members')\nFROM\n    sys.database_role_members                AS DRM\n    RIGHT OUTER JOIN sys.database_principals AS DP1 ON DRM.role_principal_id   = DP1.principal_id\n    LEFT OUTER JOIN sys.database_principals  AS DP2 ON DRM.member_principal_id = DP2.principal_id\nWHERE\n    DP1.type = 'R'\nORDER BY\n    DP1.name;\n\n\n--Role Securables\nSELECT\n    Securable = 'GRANT ' + perm.permission_name + ' ON '\n                + CASE perm.class_desc\n                      WHEN 'SCHEMA' THEN\n                          SCHEMA_NAME(perm.major_id)\n                      WHEN 'OBJECT_OR_COLUMN' THEN\n                          CASE\n                              WHEN perm.minor_id = 0 THEN\n                                  OBJECT_NAME(perm.major_id)COLLATE Latin1_General_CI_AS_KS_WS\n                              ELSE\n                          (\n                              SELECT\n                                  OBJECT_NAME(object_id) + ' (' + name + ')'\n                              FROM\n                                  sys.columns\n                              WHERE\n                                  object_id     = perm.major_id\n                                  AND column_id = perm.minor_id\n                          )\n                          END\n                      ELSE\n                          'other'\n                  END + ' TO ' + prin.name COLLATE Latin1_General_CI_AS_KS_WS\nFROM\n    sys.database_permissions           AS perm\n    INNER JOIN sys.database_principals AS prin ON perm.grantee_principal_id = prin.principal_id\n    LEFT JOIN sys.objects              AS o ON o.object_id                  = perm.major_id -- consider schemas\nWHERE\n    perm.major_id > 0\n    AND perm.permission_name IN ( 'SELECT', 'INSERT', 'UPDATE', 'DELETE' );",
  "placeholders": []
}